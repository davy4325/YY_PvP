const AmfTypes=require('./AmfTypes');const BinaryParser=require('./BinaryParser');const utf8=require('./utf8');const AMFMessage=require('./AMFMessage');const AMFTraits=require('./AMFTraits');var AMFDeserializer=cc.Class({properties:{},ctor:function(){this.inited=false},show_init_error:function(){cc.log("error: AMFDeserializer Initialization first!!!")},init:function(src){this.inited=true;this.s=src||'';this.i=0;this.resetRefs();this.beParser=this.bin_parser(true,true);this.leParser=this.bin_parser(false,true)},bin_parser:function(bigEndian,allowExceptions){if(!this.inited){this.show_init_error();return}var bin=new BinaryParser();bin.init(bigEndian,allowExceptions);return bin},header:function(value,requestURI,responseURI){var head=new AMFMessage();head.init(value,requestURI,responseURI);return head},message:function(value,requestURI,responseURI){var msg=new AMFMessage();msg.init(value,requestURI,responseURI);return msg},traits:function(value,requestURI,responseURI){return new AMFTraits()},leftPad:function(s,n,c){while(s.length<n){s=c+s}return s},resetRefs:function(){if(!this.inited){this.show_init_error();return}this.refObj=[];this.refStr=[];this.refTra=[]},length:function(){return this.s.length},shiftBytes:function(n){if(!this.inited){this.show_init_error();return}if(n===0){return''}var s=this.s.slice(0,n);if(s.length!==n){throw new Error("Not enough input to read "+n+" bytes, got "+s.length+", offset "+this.i);}this.s=this.s.slice(n);this.i+=n;return s},getU8:function(n){if(this.s.length<n-1){return-1}var s=this.s[n];return s.charCodeAt(0)},readU8:function(){var s=this.shiftBytes(1);return s.charCodeAt(0)},readU16:function(){var s=this.shiftBytes(2);return this.beParser.toWord(s)},readU32:function(){var s=this.shiftBytes(4);return this.beParser.toDWord(s)},readDouble:function(){var s=this.shiftBytes(8);if('\0\0\0\0\0\0\xF8\x7F'===s){return Number.NaN}return this.beParser.toDouble(s)},readU29:function(){var i;var n=0;var t=0;while(true){if(++t===5){throw new Error("U29 range error, offset "+this.i);}i=this.readU8();if(4===t){n=i|(n<<1);break}n|=(i&0x7F);if(i&0x80){n<<=7;continue}else{break}}return n},readInteger:function(version){if(version===AmfTypes.AMF0){return this.readDouble()}return this.readU29()},readUTF8:function(version){var str,len;if(version===AmfTypes.AMF3||version==null){var n=this.readU29();if(n&1){len=n>>1;if(len===0){return''}str=this.shiftBytes(len);this.refStr.push(str)}else{var idx=n>>1;if(this.refStr[idx]==null){throw new Error("No string reference at index "+idx+", offset "+this.i);}str=this.refStr[idx]}}else{len=this.readU16();str=this.shiftBytes(len)}return utf8.collapse(str)},readValue:function(version){if(!this.inited){this.show_init_error();return}var marker=this.readU8();if(version===AmfTypes.AMF0&&marker===AmfTypes.AMF0_AMV_PLUS){version=AmfTypes.AMF3;marker=this.readU8()}switch(version){case AmfTypes.AMF3:switch(marker){case AmfTypes.AMF3_UNDEFINED:return undefined;case AmfTypes.AMF3_NULL:return null;case AmfTypes.AMF3_FALSE:return false;case AmfTypes.AMF3_TRUE:return true;case AmfTypes.AMF3_INTEGER:return this.readInteger();case AmfTypes.AMF3_DOUBLE:return this.readDouble();case AmfTypes.AMF3_STRING:return this.readUTF8(AmfTypes.AMF3);case AmfTypes.AMF3_ARRAY:return this.readArray();case AmfTypes.AMF3_OBJECT:return this.readObject(AmfTypes.AMF3);case AmfTypes.AMF3_DATE:return this.readDate();case AmfTypes.AMF3_BYTE_ARRAY:throw new Error('ByteArrays not yet supported, sorry');default:throw new Error('Type error, unsupported AMF3 marker: 0x'+this.leftPad(marker.toString(16),2,'0')+', offset '+this.i);}default:switch(marker){case AmfTypes.AMF0_NUMBER:return this.readDouble();case AmfTypes.AMF0_STRING:return this.readUTF8(AmfTypes.AMF0);case AmfTypes.AMF0_UNDEFINED:return undefined;case AmfTypes.AMF0_NULL:return null;case AmfTypes.AMF0_BOOLEAN:return this.readBoolean();case AmfTypes.AMF0_STRICT_ARRAY:return this.readStrictArray();case AmfTypes.AMF0_DATE:return this.readDate();case AmfTypes.AMF0_OBJECT:return this.readObject(AmfTypes.AMF0);default:throw new Error('Type error, unsupported AMF0 marker: 0x'+this.leftPad(marker.toString(16),2,'0')+', offset '+this.i);}}},readBoolean:function(){return Boolean(this.readU8())},readStrictArray:function(){var a=[];var n=this.readU32();for(var i=0;i<n;i++){a.push(this.readValue(AmfTypes.AMF0))}return a},readArray:function(){var a=[];var n=this.readU29();if(n&1){this.refObj.push(a);var len=n>>1;var key;while(key=this.readUTF8(AmfTypes.AMF3)){a[key]=this.readValue(AmfTypes.AMF3)}for(var i=0;i<len;i++){a.push(this.readValue(AmfTypes.AMF3))}}else{var idx=n>>1;if(this.refObj[idx]==null){throw new Error("No array reference at index "+idx+", offset "+this.i);}a=this.refObj[idx]}return a},readObject:function(version){var prop,Obj={};if(version===AmfTypes.AMF0){while(prop=this.readUTF8(AmfTypes.AMF0)){Obj[prop]=this.readValue(AmfTypes.AMF0)}var end=this.readU8();if(end!==AmfTypes.AMF0_OBJECT_END){throw new Error('Expected object end marker, got 0x'+end.toString(16));}return Obj}var Traits;var n=this.readU29();if(n&1){if(n&2){Traits=this.traits();this.refTra.push(Traits);if(n&4){Traits.clss=this.readUTF8(AmfTypes.AMF3);throw new Error('Externalizable classes not yet supported, sorry');}else{Traits.dyn=Boolean(n&8);Traits.clss=this.readUTF8(AmfTypes.AMF3);var proplen=n>>4;for(var i=0,prop;i<proplen;i++){prop=this.readUTF8(AmfTypes.AMF3);Traits.props.push(prop)}}}else{var idx=n>>2;if(this.refTra[idx]==null){throw new Error("No traits reference at index "+idx+", offset "+this.i);}Traits=this.refTra[idx]}this.refObj.push(Obj);for(var i=0;i<Traits.props.length;i++){prop=Traits.props[i];Obj[prop]=this.readValue(AmfTypes.AMF3)}if(Traits.clss){Obj["type"]=Traits.clss}if(Traits.dyn){while(prop=this.readUTF8(AmfTypes.AMF3)){Obj[prop]=this.readValue(AmfTypes.AMF3)}}}else{var idx=n>>1;if(this.refObj[idx]==null){throw new Error("No object reference at index "+idx+", offset "+this.i);}Obj=this.refObj[idx]}return Obj},readDate:function(){var u,d;var n=this.readU29();if(n&1){u=this.readDouble();d=new Date(u);this.refObj.push(d)}else{var idx=n>>1;if(this.refObj[idx]==null||!this.refObj[idx]instanceof Date){throw new Error("No date object reference at index "+idx+", offset "+this.i);}d=this.refObj[idx]}return d},readHeader:function(){if(!this.inited){this.show_init_error();return}this.resetRefs();var name=this.readUTF8(AmfTypes.AMF0);var Header=this.header(name,'');Header.mustunderstand=Boolean(this.readU8());var len=this.readU32();Header.value=this.readValue(AmfTypes.AMF0);return Header},readMessage:function(){if(!this.inited){this.show_init_error();return}this.resetRefs();var Msg=this.message('','','');Msg.requestURI=this.readUTF8(AmfTypes.AMF0);Msg.responseURI=this.readUTF8(AmfTypes.AMF0);var len=this.readU32();Msg.value=this.readValue(AmfTypes.AMF0);return Msg},});